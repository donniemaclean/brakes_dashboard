<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eat Balanced ‚Äî Brakes Dashboard</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><text y='28' font-size='28'>üçï</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', sans-serif; background: #f7f9f7; }
  #root { min-height: 100vh; }
  #loading { display:flex; align-items:center; justify-content:center; height:100vh;
             font-family:sans-serif; color:#5A6B5A; flex-direction:column; gap:12px; }
  #loading .spinner { width:40px; height:40px; border:4px solid #E0E8E0;
             border-top:4px solid #3FA535; border-radius:50%; animation:spin 1s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }
</style>
</head>
<body>
<div id="root">
  <div id="loading">
    <div class="spinner"></div>
    <div>Loading dashboard‚Ä¶</div>
  </div>
</div>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-is@18/umd/react-is.production.min.js"></script>
<script crossorigin src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
<script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script>
window.addEventListener("DOMContentLoaded", function() {
  setTimeout(function() {
    var missing = [];
    if (typeof React === "undefined") missing.push("React");
    if (typeof ReactDOM === "undefined") missing.push("ReactDOM");
    if (typeof Recharts === "undefined") missing.push("Recharts");
    if (typeof Babel === "undefined") missing.push("Babel");
    if (missing.length > 0) {
      document.getElementById("loading").innerHTML =
        '<div style="color:#EF4444;font-weight:bold">Failed to load: ' + missing.join(", ") + '</div>' +
        '<div style="color:#5A6B5A;font-size:13px">Check your internet connection and try refreshing.</div>';
    }
  }, 8000);
});
window.onerror = function(msg, url, line) {
  var el = document.getElementById("loading");
  if (el) el.innerHTML = '<div style="color:#EF4444;font-weight:bold">Error: ' + msg + '</div>' +
    '<div style="color:#5A6B5A;font-size:13px">Line ' + line + '</div>';
};
</script>
<script type="text/babel" data-type="module">
const { useState, useMemo } = window.React;
const { LineChart, Line, BarChart, Bar, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ComposedChart, Cell, ReferenceLine } = window.Recharts;

"""
Dashboard Generator & GitHub Pages Pusher
==========================================
Reads all tabs from Google Sheets, builds a self-contained HTML dashboard,
and pushes index.html to a GitHub Pages repo via the GitHub API.
"""

from datetime import datetime, timedelta
from typing import Optional


log = logging.getLogger("brakes")


# ---------------------------------------------------------------------------
# 1. Read all data from Google Sheets
# ---------------------------------------------------------------------------

def read_dashboard_data(sh) -> dict:
    """Read all tabs needed for the dashboard from the Google Sheet."""
    data = {}

    # --- Brakes Sales tab ---
    # Layout: Row 1-2 headers, data from row 3 (newest first)
    # Columns may be: B=date, C=week, D=sales  OR  B=week, C=year, D=sales
    # We detect which layout based on the first data row
    try:
        ws = sh.worksheet("Brakes Sales")
        rows = ws.get_all_values()
        sales = []
        
        # Detect layout from first data row (row 3 = index 2)
        has_date_col = False
        if len(rows) > 2 and len(rows[2]) >= 4:
            b_val = str(rows[2][1]).strip()
            # If B looks like a date (contains / or letters), it's date,week,sales
            # If B looks like a small number (week number), it's week,year,sales
            if '/' in b_val or any(c.isalpha() for c in b_val):
                has_date_col = True
            else:
                try:
                    num = int(float(b_val))
                    # Week numbers are 1-53, years are 2020+
                    has_date_col = num > 100  # serial date number
                except (ValueError, TypeError):
                    pass
        
        log.info(f"[Dashboard] Brakes Sales layout: {'date,week,sales' if has_date_col else 'week,year,sales'}")
        
        for r in rows[2:]:  # skip 2 header rows
            if len(r) < 4 or (not r[1] and not r[0]):
                continue
            try:
                if has_date_col:
                    # B=date, C=week, D=sales
                    date_str = r[1]
                    week_num = int(float(r[2]))
                    cases = int(float(r[3]))
                    dt = None
                    for fmt in ["%d/%m/%Y", "%d %b %y", "%d %b %Y", "%Y-%m-%d"]:
                        try:
                            dt = datetime.strptime(str(date_str).strip(), fmt)
                            break
                        except (ValueError, TypeError):
                            continue
                    if not dt:
                        try:
                            dt = datetime(1899, 12, 30) + timedelta(days=float(date_str))
                        except (ValueError, TypeError):
                            continue
                    year = dt.year if dt.year > 100 else dt.year + 2000
                else:
                    # B=week, C=year, D=sales (no date column)
                    week_num = int(float(r[1]))
                    year = int(float(r[2]))
                    cases = int(float(r[3]))
                    # Construct a Monday date from week+year
                    dt = datetime.strptime(f"{year}-W{week_num:02d}-1", "%G-W%V-%u")
                
                if dt:
                    sales.append([dt.strftime("%Y-%m-%d"), week_num, year, cases])
            except (ValueError, IndexError):
                continue
        data["sales"] = sales
        log.info(f"[Dashboard] Read {len(sales)} weekly sales rows")
    except Exception as e:
        log.error(f"[Dashboard] Failed to read Brakes Sales: {e}")
        data["sales"] = []

    # --- Inventory tab ---
    try:
        ws = sh.worksheet("Inventory")
        rows = ws.get_all_values()
        inv = []
        for r in rows[1:]:
            if not r[0]:
                continue
            try:
                # Parse date from DD MMM YY or DD/MM/YYYY format
                date_str = r[0].strip()
                dt = None
                for fmt in ("%d %b %y", "%d/%m/%Y", "%d/%m/%y", "%Y-%m-%d"):
                    try:
                        dt = datetime.strptime(date_str, fmt)
                        break
                    except ValueError:
                        continue
                if not dt:
                    continue

                def safe_int(v):
                    if not v or v == "":
                        return 0
                    return int(float(v.replace(",", "")))

                def safe_float(v):
                    if not v or v == "":
                        return 0.0
                    return round(float(v.replace(",", "")), 1)

                # Stock: cols E(4), F(5), G(6), H(7) = NH, BEP, TAM, Other
                nh = safe_int(r[4]) if len(r) > 4 else 0
                bep = safe_int(r[5]) if len(r) > 5 else 0
                tam = safe_int(r[6]) if len(r) > 6 else 0
                oth = safe_int(r[7]) if len(r) > 7 else 0

                # Deliveries: cols J(9), K(10), L(11), M(12)
                dnh = safe_int(r[9]) if len(r) > 9 else 0
                dbep = safe_int(r[10]) if len(r) > 10 else 0
                dtam = safe_int(r[11]) if len(r) > 11 else 0
                dtot = safe_int(r[12]) if len(r) > 12 else 0

                # Sales: cols O(14), P(15), Q(16), R(17), S(18)
                stot = safe_int(r[14]) if len(r) > 14 else 0
                snh = safe_int(r[15]) if len(r) > 15 else 0
                sbep = safe_int(r[16]) if len(r) > 16 else 0
                stam = safe_int(r[17]) if len(r) > 17 else 0
                soth = safe_int(r[18]) if len(r) > 18 else 0

                # Averages: cols U(20), V(21), W(22)
                anh = safe_float(r[20]) if len(r) > 20 else 0.0
                abep = safe_float(r[21]) if len(r) > 21 else 0.0
                atam = safe_float(r[22]) if len(r) > 22 else 0.0

                inv.append([
                    dt.strftime("%Y-%m-%d"),
                    nh, bep, tam, oth,
                    dnh, dbep, dtam, dtot,
                    stot, snh, sbep, stam, soth,
                    anh, abep, atam
                ])
            except Exception:
                continue
        data["inventory"] = inv
        log.info(f"[Dashboard] Read {len(inv)} inventory rows")
    except Exception as e:
        log.error(f"[Dashboard] Failed to read Inventory: {e}")
        data["inventory"] = []

    # --- Forecast tab ---
    try:
        ws = sh.worksheet("Forecast")

        # Current 8-week forecast: B5:I5 (dates), B6:I6 (weeks), B7:I7 (values)
        dates_row = ws.get("B5:I5")[0] if ws.get("B5:I5") else [""] * 8
        weeks_row = ws.get("B6:I6")[0] if ws.get("B6:I6") else [""] * 8
        vals_row = ws.get("B7:I7")[0] if ws.get("B7:I7") else [""] * 8

        forecast_8wk = []
        for i in range(8):
            d = dates_row[i] if i < len(dates_row) else ""
            w = weeks_row[i] if i < len(weeks_row) else ""
            v = vals_row[i] if i < len(vals_row) else ""
            try:
                v_int = int(float(str(v).replace(",", ""))) if v else 0
            except (ValueError, TypeError):
                v_int = 0
            try:
                w_int = int(float(str(w))) if w else 0
            except (ValueError, TypeError):
                w_int = 0
            forecast_8wk.append([str(d), w_int, v_int])
        data["forecast_8wk"] = forecast_8wk

        # Forecast accuracy log: from row 12 onwards
        rows = ws.get_all_values()
        fc_data = []
        # Find header row for accuracy table
        for i, row in enumerate(rows):
            if row and "Week Commencing" in str(row[0]):
                # Data starts from next row
                for r in rows[i + 1:]:
                    if not r[0]:
                        continue
                    try:
                        dt_str = r[0].strip()
                        dt = None
                        for fmt in ("%d/%m/%Y", "%d %b %y", "%Y-%m-%d"):
                            try:
                                dt = datetime.strptime(dt_str, fmt)
                                break
                            except ValueError:
                                continue
                        if not dt:
                            continue
                        week = int(float(r[1])) if r[1] else dt.isocalendar()[1]
                        fc = int(float(str(r[3]).replace(",", ""))) if r[3] else 0
                        ac = int(float(str(r[4]).replace(",", ""))) if r[4] else 0
                        fc_data.append([dt.strftime("%Y-%m-%d"), week, fc, ac])
                    except Exception:
                        continue
                break
        data["forecast_history"] = fc_data
        log.info(f"[Dashboard] Read {len(fc_data)} forecast accuracy rows, 8wk forecast: {forecast_8wk[0]}")
    except Exception as e:
        log.error(f"[Dashboard] Failed to read Forecast: {e}")
        data["forecast_8wk"] = []
        data["forecast_history"] = []

    # --- Supplier Delivery Record tab ---
    try:
        ws = sh.worksheet("Supplier Delivery Record")
        rows = ws.get_all_values()
        perf = []
        for r in rows[1:]:
            if not r[0]:
                continue
            try:
                dt_str = r[0] if r[0] else r[1]
                dt = None
                for fmt in ("%d %b %y", "%d/%m/%Y", "%Y-%m-%d"):
                    try:
                        dt = datetime.strptime(dt_str.strip(), fmt)
                        break
                    except ValueError:
                        continue
                if not dt:
                    continue
                score_str = str(r[3]).strip() if len(r) > 3 and r[3] else ""
                if score_str.endswith("%"):
                    score = float(score_str.replace("%", "")) / 100
                else:
                    score = float(score_str) if score_str else 0
                note = r[4].strip() if len(r) > 4 else ""
                perf.append([dt.strftime("%Y-%m-%d"), score, note])
            except Exception:
                continue
        data["supplier_perf"] = perf
        log.info(f"[Dashboard] Read {len(perf)} supplier delivery records")
    except Exception as e:
        log.error(f"[Dashboard] Failed to read Supplier Delivery Record: {e}")
        data["supplier_perf"] = []

    return data


# ---------------------------------------------------------------------------
# 2. Build the HTML dashboard
# ---------------------------------------------------------------------------

def build_dashboard_html(data: dict, jsx_template_path: Optional[str] = None) -> str:
    """
    Build a self-contained HTML dashboard.

    If jsx_template_path is provided, reads the .jsx file and wraps it.
    Otherwise, uses the embedded JSX from the template.
    """
    # Read the JSX template
    jsx = ""
    if jsx_template_path and os.path.exists(jsx_template_path):
        with open(jsx_template_path) as f:
            jsx = f.read()
        log.info(f"[Dashboard] Loaded JSX from path: {jsx_template_path} ({len(jsx):,} chars)")
    else:
        # Fallback: look in same directory as this script
        script_dir = os.path.dirname(os.path.abspath(__file__))
        jsx_path = os.path.join(script_dir, "brakes-dashboard.jsx")
        log.info(f"[Dashboard] JSX template path not found, trying fallback: {jsx_path}")
        if os.path.exists(jsx_path):
            with open(jsx_path) as f:
                jsx = f.read()
            log.info(f"[Dashboard] Loaded JSX from fallback ({len(jsx):,} chars)")
        else:
            log.error(f"[Dashboard] No JSX template found at {jsx_path}")
            return ""

    # Replace embedded data arrays with fresh data
    if data.get("sales"):
        sales_json = json.dumps(data["sales"], separators=(",", ":"))
        jsx = re.sub(r'const RAW_S = \[.*?\];', f'const RAW_S = {sales_json};', jsx, flags=re.DOTALL)

    if data.get("inventory"):
        inv_json = json.dumps(data["inventory"], separators=(",", ":"))
        jsx = re.sub(r'const RAW_I = \[.*?\];', f'const RAW_I = {inv_json};', jsx, flags=re.DOTALL)

    if data.get("forecast_history"):
        fc_json = json.dumps(data["forecast_history"], separators=(",", ":"))
        jsx = re.sub(r'const RAW_F = \[.*?\];', f'const RAW_F = {fc_json};', jsx, flags=re.DOTALL)

    if data.get("supplier_perf"):
        perf_json = json.dumps(data["supplier_perf"], separators=(",", ":"))
        jsx = re.sub(r'const RAW_P = \[.*?\];', f'const RAW_P = {perf_json};', jsx, flags=re.DOTALL)

    if data.get("forecast_8wk"):
        fc8_json = json.dumps(data["forecast_8wk"], separators=(",", ":"))
        jsx = re.sub(
            r'const FORECAST_8WK = \[.*?\];',
            f'const FORECAST_8WK = {fc8_json};',
            jsx, flags=re.DOTALL
        )
        # Also update the currentForecast value
        this_week_fc = data["forecast_8wk"][0][2] if data["forecast_8wk"] else 0
        jsx = re.sub(
            r'const currentForecast = FORECAST_8WK\[0\]\?\.\[2\] \|\| 0;',
            f'const currentForecast = FORECAST_8WK[0]?.[2] || 0;',
            jsx
        )

    # Strip import lines and convert export default
    lines = jsx.split("\n")
    body_lines = []
    for line in lines:
        if line.startswith("import "):
            continue
        if line.startswith("export default function Dashboard()"):
            body_lines.append("function Dashboard() {")
            continue
        body_lines.append(line)
    jsx_body = "\n".join(body_lines)
    log.info(f"[Dashboard] JSX body after processing: {len(jsx_body):,} chars")

    # Build HTML using concatenation (NOT f-string) because jsx_body contains
    # thousands of { } characters that would break Python f-string parsing
    html_parts = [
        '<!DOCTYPE html>',
        '<html lang="en">',
        '<head>',
        '<meta charset="UTF-8">',
        '<meta name="viewport" content="width=device-width, initial-scale=1.0">',
        '<title>Eat Balanced ‚Äî Brakes Dashboard</title>',
        "<link rel=\"icon\" href=\"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><text y='28' font-size='28'>üçï</text></svg>\">",
        '<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">',
        '<style>',
        '  * { margin: 0; padding: 0; box-sizing: border-box; }',
        "  body { font-family: 'Inter', sans-serif; background: #f7f9f7; }",
        '  #root { min-height: 100vh; }',
        '  #loading { display:flex; align-items:center; justify-content:center; height:100vh;',
        '             font-family:sans-serif; color:#5A6B5A; flex-direction:column; gap:12px; }',
        '  #loading .spinner { width:40px; height:40px; border:4px solid #E0E8E0;',
        '             border-top:4px solid #3FA535; border-radius:50%; animation:spin 1s linear infinite; }',
        '  @keyframes spin { to { transform:rotate(360deg); } }',
        '</style>',
        '</head>',
        '<body>',
        '<div id="root">',
        '  <div id="loading">',
        '    <div class="spinner"></div>',
        '    <div>Loading dashboard‚Ä¶</div>',
        '  </div>',
        '</div>',
        '<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>',
        '<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>',
        '<script crossorigin src="https://unpkg.com/react-is@18/umd/react-is.production.min.js"></script>',
        '<script crossorigin src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>',
        '<script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>',
        '<script>',
        'window.addEventListener("DOMContentLoaded", function() {',
        '  setTimeout(function() {',
        '    var missing = [];',
        '    if (typeof React === "undefined") missing.push("React");',
        '    if (typeof ReactDOM === "undefined") missing.push("ReactDOM");',
        '    if (typeof Recharts === "undefined") missing.push("Recharts");',
        '    if (typeof Babel === "undefined") missing.push("Babel");',
        '    if (missing.length > 0) {',
        '      document.getElementById("loading").innerHTML =',
        '        \'<div style="color:#EF4444;font-weight:bold">Failed to load: \' + missing.join(", ") + \'</div>\' +',
        '        \'<div style="color:#5A6B5A;font-size:13px">Check your internet connection and try refreshing.</div>\';',
        '    }',
        '  }, 8000);',
        '});',
        'window.onerror = function(msg, url, line) {',
        '  var el = document.getElementById("loading");',
        '  if (el) el.innerHTML = \'<div style="color:#EF4444;font-weight:bold">Error: \' + msg + \'</div>\' +',
        '    \'<div style="color:#5A6B5A;font-size:13px">Line \' + line + \'</div>\';',
        '};',
        '</script>',
        '<script type="text/babel" data-type="module">',
        'const { useState, useMemo } = window.React;',
        'const { LineChart, Line, BarChart, Bar, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ComposedChart, Cell, ReferenceLine } = window.Recharts;',
        '',
        jsx_body,
        '',
        'window.ReactDOM.createRoot(document.getElementById("root")).render(<Dashboard />);',
        '</script>',
        '</body>',
        '</html>',
    ]
    html = "\n".join(html_parts)

    log.info(f"[Dashboard] Built HTML: {len(html):,} bytes")
    return html


# ---------------------------------------------------------------------------
# 3. Push to GitHub Pages
# ---------------------------------------------------------------------------

def push_to_github(html_content: str, repo: str, token: str,
                   file_path: str = "index.html",
                   branch: str = "main",
                   commit_message: str = None) -> bool:
    """
    Push index.html to a GitHub repo using the GitHub Contents API.

    Args:
        html_content: The HTML string to push
        repo: GitHub repo in "owner/repo" format
        token: GitHub personal access token (with repo scope)
        file_path: Path within repo (default: "index.html")
        branch: Branch name (default: "main")
        commit_message: Custom commit message
    """
    if not token or not repo:
        log.warning("[GitHub] Missing GITHUB_TOKEN or GITHUB_REPO ‚Äî skipping push")
        return False

    api_url = f"https://api.github.com/repos/{repo}/contents/{file_path}"
    headers = {
        "Authorization": f"token {token}",
        "Accept": "application/vnd.github.v3+json",
        "User-Agent": "BrakesAutomation/1.0",
    }

    if not commit_message:
        commit_message = f"Update dashboard ‚Äî {datetime.now().strftime('%d %b %Y %H:%M')}"

    # Get the current file SHA (needed for updates, not creates)
    sha = None
    try:
        resp = requests.get(api_url, headers=headers, params={"ref": branch})
        if resp.status_code == 200:
            sha = resp.json().get("sha")
            log.info(f"[GitHub] Existing file found (sha: {sha[:8]}...)")
        elif resp.status_code == 404:
            log.info("[GitHub] File not found ‚Äî will create new")
        else:
            log.warning(f"[GitHub] Unexpected status checking file: {resp.status_code}")
    except Exception as e:
        log.warning(f"[GitHub] Error checking existing file: {e}")

    # Encode content as base64
    content_b64 = base64.b64encode(html_content.encode("utf-8")).decode("utf-8")

    # Build the PUT request body
    body = {
        "message": commit_message,
        "content": content_b64,
        "branch": branch,
    }
    if sha:
        body["sha"] = sha

    try:
        resp = requests.put(api_url, headers=headers, json=body)
        if resp.status_code in (200, 201):
            result = resp.json()
            new_sha = result.get("content", {}).get("sha", "")[:8]
            html_url = result.get("content", {}).get("html_url", "")
            log.info(f"[GitHub] ‚úì Pushed {file_path} (sha: {new_sha})")
            log.info(f"[GitHub] Dashboard URL: https://{repo.split('/')[0]}.github.io/{repo.split('/')[1]}/")
            return True
        else:
            log.error(f"[GitHub] ‚úó Push failed: {resp.status_code} ‚Äî {resp.text[:200]}")
            return False
    except Exception as e:
        log.error(f"[GitHub] ‚úó Push error: {e}")
        return False


# ---------------------------------------------------------------------------
# 4. Top-level function called from main automation
# ---------------------------------------------------------------------------

def update_dashboard(sh, jsx_template_path: Optional[str] = None) -> bool:
    """
    Read data from Sheets, build HTML, push to GitHub Pages.
    Returns True if successful, False otherwise.
    """
    token = os.getenv("GITHUB_TOKEN", "")
    repo = os.getenv("GITHUB_REPO", "")

    if not token or not repo:
        log.info("[Dashboard] GitHub not configured (GITHUB_TOKEN / GITHUB_REPO) ‚Äî skipping")
        return False

    try:
        # Step 1: Read all data from Sheets
        log.info("[Dashboard] Reading data from Google Sheets...")
        data = read_dashboard_data(sh)

        if not data.get("sales"):
            log.warning("[Dashboard] No sales data ‚Äî aborting dashboard update")
            return False

        # Step 2: Build the HTML
        log.info("[Dashboard] Generating dashboard HTML...")
        html = build_dashboard_html(data, jsx_template_path)
        if not html:
            log.error("[Dashboard] HTML generation failed")
            return False

        # Step 3: Push to GitHub
        log.info("[Dashboard] Pushing to GitHub Pages...")
        return push_to_github(html, repo, token)

    except Exception as e:
        log.error(f"[Dashboard] Error: {e}")
        return False


window.ReactDOM.createRoot(document.getElementById("root")).render(<Dashboard />);
</script>
</body>
</html>